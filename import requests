

# Configura√ß√µes
EVOLUTION_URL = "http://78.142.242.82:8080"
API_KEY = "Josevfg2409@"
INSTANCE_NAME = "BotMedico"

def configurar_webhook():
    """Configura o webhook para a inst√¢ncia do bot"""
    print("=" * 80)
    print("üîó CONFIGURANDO WEBHOOK")
    print("=" * 80)
    print()
    
    # URL do webhook (IMPORTANTE: usar nome do container no Docker)
    webhook_url = "http://bot-medico:5000/webhook"
    
    url = f"{EVOLUTION_URL}/webhook/set/{INSTANCE_NAME}"
    headers = {
        "apikey": API_KEY,
        "Content-Type": "application/json"
    }
    
    payload = {
        "webhook": {
            "enabled": True,
            "url": webhook_url,
            "webhook_by_events": True,
            "webhook_base64": False,
            "events": [
                "QRCODE_UPDATED",
                "MESSAGES_UPSERT",
                "MESSAGES_UPDATE",
                "MESSAGES_DELETE",
                "SEND_MESSAGE",
                "CONNECTION_UPDATE"
            ]
        }
    }
    
    print(f"Inst√¢ncia: {INSTANCE_NAME}")
    print(f"Webhook URL: {webhook_url}")
    print()
    print("Configurando...")
    
    try:
        response = requests.post(url, json=payload, headers=headers)
        
        print(f"Status: {response.status_code}")
        print(f"Resposta: {json.dumps(response.json(), indent=2)}")
        
        if response.status_code in [200, 201]:
            print("\n‚úÖ Webhook configurado com sucesso!")
            print()
            print("üìã Pr√≥ximos passos:")
            print("1. Reinicie o container do bot: docker-compose restart bot-medico")
            print("2. Envie uma mensagem de teste para o n√∫mero do bot")
            print("3. Verifique os logs: docker logs -f bot_medico")
            return True
        else:
            print("\n‚ùå Falha ao configurar webhook")
            return False
            
    except Exception as e:
        print(f"‚ùå Erro: {e}")
        return False

def verificar_webhook():
    """Verifica a configura√ß√£o atual do webhook"""
    print("=" * 80)
    print("üîç VERIFICANDO WEBHOOK ATUAL")
    print("=" * 80)
    print()
    
    url = f"{EVOLUTION_URL}/webhook/find/{INSTANCE_NAME}"
    headers = {"apikey": API_KEY}
    
    try:
        response = requests.get(url, headers=headers)
        
        if response.status_code == 200:
            webhook_data = response.json()
            print("Configura√ß√£o atual:")
            print(json.dumps(webhook_data, indent=2))
            print()
            return webhook_data
        else:
            print(f"‚ùå Erro ao consultar: {response.status_code}")
            print("Provavelmente o webhook n√£o est√° configurado ainda.")
            return None
            
    except Exception as e:
        print(f"‚ùå Erro: {e}")
        return None

if __name__ == "__main__":
    print("\nüîó CONFIGURADOR DE WEBHOOK - BOT CLARA\n")
    
    # Verifica configura√ß√£o atual
    webhook_atual = verificar_webhook()
    
    print()
    
    if webhook_atual:
        url_atual = webhook_atual.get('webhook', {}).get('url', '')
        print(f"Webhook atual: {url_atual}")
        print()
        
        resposta = input("Deseja reconfigurar? (s/n): ")
        if resposta.lower() != 's':
            print("Opera√ß√£o cancelada.")
            exit(0)
    
    # Configura webhook
    print()
    configurar_webhook()
    
    print("\n" + "=" * 80)
    print("‚úÖ Processo conclu√≠do!")
    print("=" * 80)
